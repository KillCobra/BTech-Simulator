name: Quick integrity checks

on:
  push:
    branches: [ main ]

jobs:
  repo-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure no large unexpected files
        run: |
          # fail if any tracked file > 10MB (adjust threshold)
          git ls-tree -r --long HEAD | awk '$4 > 10000000 {print; exit 1}'

      - name: Check for CRLF / text conflicts
        run: |
          if git grep -I --line-number $'\r' -- :/ | grep -q .; then
            echo "Found CRLF in files"; git grep -I --line-number $'\r' -- :/
            exit 1
          fi

      - name: Validate JSON files (manifest/package files)
        run: |
          for f in Packages/manifest.json ProjectSettings/ProjectSettings.asset package.json package-lock.json; do
            if [ -f "$f" ]; then
              jq . "$f" >/dev/null || (echo "Invalid JSON: $f" && exit 1)
            fi
          done
        env:
          CI: true

  dotnet-compile-check:
    runs-on: ubuntu-latest
    needs: repo-checks
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install .NET SDK (for C# compile check)
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '7.0.x'

      - name: Restore packages (if any)
        run: |
          # If you have C# projects in the repo (assembly definition -> .csproj via export),
          # try to locate and build them. If none, this step will skip.
          find . -name "*.csproj" -maxdepth 4 -print -quit | tee csproj.txt
          if [ -s csproj.txt ]; then
            dotnet restore
          fi

      - name: Build C# projects (compile-only)
        run: |
          if [ -s csproj.txt ]; then
            dotnet build --no-restore --configuration Release
          else
            echo "No .csproj found â€” skipping dotnet compile check"
          fi

  unity-editor-check:
    runs-on: ubuntu-latest
    needs: [repo-checks, dotnet-compile-check]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Unity Editor (optional)
        uses: actions/cache@v4
        with:
          path: ~/.cache/unity3d
          key: unity-editor-cache-v1

      - name: Install Unity Editor (Linux, command-line)
        uses: game-ci/unity-setup@v3
        with:
          unityVersion: 6000.3.8f1   # pick your version; adjust
          githubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Unity - Import & compile in batchmode
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }} # optional if requiring activation
        run: |
          # Run Unity in batchmode and exit after asset import / compilation.
          # This avoids creating player builds; it's much faster than building.
          /opt/unity/Editor/Unity \
            -batchmode -nographics -quit \
            -projectPath $PWD \
            -logFile unity-check.log \
            -runEditorTests false \
            -executeMethod EditorUtility.SaveProject  || true
          tail -n +1 unity-check.log
          # Look for compilation errors in the log
          if grep -E "CompilerErrors: [1-9]" unity-check.log || grep -i "error CS" unity-check.log; then
            echo "Unity compilation or import errors detected"
            exit 1
          fi

      - name: Dump Unity version and summary
        run: |
          cat unity-check.log | grep -E "Unity .* version|Script compilation|Errors"
